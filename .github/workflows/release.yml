name: Build and Release RBZ

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create RBZ package
        run: |
          # Create a temporary directory for packaging
          mkdir -p package
          
          # Copy only the extension files (not dev tools, docs, etc.)
          cp first_reflections_calculator.rb package/
          cp -r first_reflections_calculator package/
          
          # Update PLUGIN_VERSION in the packaged file to match the git tag
          sed -i "s/PLUGIN_VERSION  = '.*'/PLUGIN_VERSION  = '${{ steps.version.outputs.VERSION }}'/" package/first_reflections_calculator.rb
          
          # Update copyright year to current year
          sed -i "s/Vladimiras Malyskinas [0-9]\{4\}/Vladimiras Malyskinas $(date +%Y)/" package/first_reflections_calculator.rb
          
          # Create the RBZ (which is just a ZIP file with .rbz extension)
          cd package
          zip -r ../first_reflections_calculator-${{ steps.version.outputs.VERSION }}.rbz .
          cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: First Reflections Calculator v${{ steps.version.outputs.VERSION }}
          body: |
            ## Installation
            
            1. Download `first_reflections_calculator-${{ steps.version.outputs.VERSION }}.rbz` below
            2. In SketchUp, go to **Window > Extension Manager**
            3. Click **Install Extension** and select the downloaded `.rbz` file
            
            Or install directly from the [SketchUp Extension Warehouse](https://extensions.sketchup.com/extension/4df1013f-58f9-4fe9-91f9-e3ba03920e9c/first-reflections-tool).
          files: |
            first_reflections_calculator-${{ steps.version.outputs.VERSION }}.rbz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
